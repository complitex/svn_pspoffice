<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.pspoffice.imp.service.ReferenceDataCorrectionBean">
    
    <resultMap id="referenceDataCorrection" type="org.complitex.pspoffice.imp.entity.ReferenceDataCorrection">
        <id column="pk_id" property="pkId"/>
        <result column="id" property="id"/>
        <result column="idjek" property="idjek"/>
        <result column="nkod" property="nkod"/>
        <result column="system_object_id" property="systemObjectId"/>
        <result column="entity" property="entity"/>
        <result column="processed" property="processed"/>
    </resultMap>
    
    <insert id="insert" parameterType="org.complitex.pspoffice.imp.entity.ReferenceDataCorrection" useGeneratedKeys="true" 
                keyProperty="pkId">
        INSERT INTO `${entity}_correction`(`id`, `idjek`, `nkod`, `system_object_id`, `content`) VALUES
            (#{id}, #{idjek}, #{nkod}, #{systemObjectId}, #{content})
    </insert>
    
    <update id="update" parameterType="org.complitex.pspoffice.imp.entity.ReferenceDataCorrection">
        UPDATE `${entity}_correction` SET `processed` = #{processed}, `system_object_id` = #{systemObjectId} 
        WHERE `pk_id` = #{pkId}
    </update>
    
    <select id="findById" parameterType="map" resultMap="org.complitex.pspoffice.imp.service.ReferenceDataCorrectionBean.referenceDataCorrection">
        SELECT * FROM `${entity}_correction` WHERE `id` = #{id} AND `idjek` = #{idjek}
    </select>
    
    <delete id="delete" parameterType="collection">
        DELETE FROM `${entity}_correction` WHERE `idjek` IN 
        <foreach open="(" close=")" separator="," collection="jekIds" item="idjek">
            #{idjek}
        </foreach>
    </delete>
    
    <select id="exists" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM `${entity}_correction` WHERE `idjek` = #{idjek}
    </select>
    
    <select id="countForProcessingForJeks" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM `${entity}_correction` WHERE `system_object_id` IS NULL
            AND `idjek` IN 
            <foreach open="(" close=")" separator="," collection="jekIds" item="idjek">
                #{idjek}
            </foreach>
    </select>
    
    <select id="countForProcessing" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM `${entity}_correction` WHERE `system_object_id` IS NULL
            AND `processed` = 0 AND `idjek` = #{idjek}
    </select>
    
    <select id="findForProcessing" resultMap="org.complitex.pspoffice.imp.service.ReferenceDataCorrectionBean.referenceDataCorrection"
            parameterType="map">
        SELECT c.*, '${entity}' `entity` FROM `${entity}_correction` c WHERE c.`idjek` = #{idjek} AND c.`system_object_id` IS NULL
            AND c.`processed` = 0 LIMIT ${size}
    </select>
    
    <update id="clearProcessingStatus" parameterType="map">
        UPDATE `${entity}_correction` SET `processed` = 0 WHERE `idjek` IN 
        <foreach open="(" close=")" separator="," collection="jekIds" item="idjek">
            #{idjek}
        </foreach>
    </update>
    
    <select id="checkReservedObject" parameterType="map" resultType="int">
        SELECT 
            (SELECT COUNT(*) FROM `${entity}_correction` WHERE `id` = #{objectId} AND `system_object_id` IS NULL) = 0
            AND 
            (SELECT COUNT(*) FROM `${entity}_correction` WHERE `id` = #{objectId}) > 0 FROM DUAL
    </select>
    
</mapper>
