<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.pspoffice.person.strategy.service.ApartmentCardsGridBean">
    
    <sql id="join">
        LEFT JOIN `apartment_card_attribute` apartment_a ON (apartment_a.`object_id` = ac.`object_id` AND apartment_a.`status` = 'ACTIVE'
            AND apartment_a.`attribute_type_id` = ${apartmentCardAddressAT} 
            AND apartment_a.`value_type_id` = ${apartmentCardApartmentVT})
        LEFT JOIN `apartment_card_attribute` room_a ON (room_a.`object_id` = ac.`object_id` AND room_a.`status` = 'ACTIVE'
            AND room_a.`attribute_type_id` = ${apartmentCardAddressAT} 
            AND room_a.`value_type_id` = ${apartmentCardRoomVT})
            
        LEFT JOIN `room` room ON (room.`object_id` = room_a.`value_id` AND room.`status` = 'ACTIVE')
        LEFT JOIN `apartment` ap ON (ap.`status` = 'ACTIVE'
            AND ap.`object_id` = room.`parent_id` AND room.`parent_entity_id` = 100)
    </sql>
    
    <sql id="where">
        WHERE ac.`status` = 'ACTIVE' AND
        (apartment_a.`value_id` = #{apartmentId} OR ap.`object_id` = #{apartmentId})
        <if test="not admin">
            AND ac.`permission_id` IN ${apartmentCardPermissionString}
        </if>
    </sql>
    
    <select id="count" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT ac.`object_id`) FROM `apartment_card` ac 
        <include refid="org.complitex.pspoffice.person.strategy.service.ApartmentCardsGridBean.join"/>
        <include refid="org.complitex.pspoffice.person.strategy.service.ApartmentCardsGridBean.where"/>
    </select>

    <select id="find" resultType="long" parameterType="map">
        SELECT DISTINCT ac.`object_id` FROM `apartment_card` ac
        <include refid="org.complitex.pspoffice.person.strategy.service.ApartmentCardsGridBean.join"/>
        <include refid="org.complitex.pspoffice.person.strategy.service.ApartmentCardsGridBean.where"/>
        
        <if test="size > 0">
            LIMIT ${start},${size}
        </if>
    </select>
</mapper>
