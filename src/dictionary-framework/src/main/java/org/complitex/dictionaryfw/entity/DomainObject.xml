<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.dictionaryfw.entity.Entity">

    <resultMap id="Entity" type="Entity">
        <id column="object_id" property="id"/>
        <id column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="status" property="status"/>
        <result column="parent_id" property="parentId"/>
        <result column="parent_table" property="parentTable"/>
        <result column="parent_entity_id" property="parentEntityId"/>
        <result column="entity_type_id" property="entityTypeId"/>
    </resultMap>

    <resultMap id="Entity_view" type="Entity" extends="org.complitex.dictionaryfw.entity.Entity.Entity">
        <collection ofType="EntityAttribute" property="attributes" column="{table = table_name, id = object_id, locale = locale, startDate = start_date}"
        select="org.complitex.dictionaryfw.entity.EntityAttribute.find_view"/>
    </resultMap>

    <resultMap id="Entity_edit" type="Entity" extends="org.complitex.dictionaryfw.entity.Entity.Entity">
        <!--<association property="parent" column="{id = parent_id, locale = locale, table = parent_table}"
        select="org.complitex.dictionaryfw.entity.Entity.findParentById"/>-->
        
        <collection ofType="EntityAttribute" property="attributes" column="{table = table_name, id = object_id, locale = locale, startDate = start_date}"
        select="org.complitex.dictionaryfw.entity.EntityAttribute.find_edit"/>
    </resultMap>

    <insert id="insert" parameterType="InsertParameter">
        INSERT INTO `${table}` (`object_id`, `status`, `start_date`, `end_date`, `parent_id`, `parent_entity_id`, `entity_type_id`) VALUES
        (#{entity.id}, #{entity.status}, #{entity.startDate}, #{entity.endDate}, #{entity.parentId}, #{entity.parentEntityId}, #{entity.entityTypeId})
    </insert>

    <!--  customize -->
    <sql id="findById">
        SELECT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        e.`parent_entity_id`, (SELECT m.`entity_table` FROM `entity` m WHERE m.`id` = e.`parent_entity_id`) as parent_table,
        e.`entity_type_id`, '${locale}' as locale, '${table}' as table_name
        FROM `${table}` e WHERE e.`status` = 'ACTIVE' AND e.`object_id` = #{id}
    </sql>

   <!-- <select id="findParentById" resultMap="Entity_view" parameterType="hashmap">
        <choose>
            <when test="table != null and id != null">
                <include refid="org.complitex.dictionaryfw.entity.Entity.findById"/>
            </when>
            <otherwise>
                SELECT NULL AS `object_id`, NULL AS `start_date`, NULL AS `end_date`, NULL AS `status`, NULL AS `parent_id`,
                NULL AS `parent_entity_id`, NULL AS parent_table,
                NULL AS `entity_type_id`, NULL AS locale, NULL AS table_name
                FROM DUAL WHERE 1=2
            </otherwise>
        </choose>
    </select>-->

    <sql id="find">
        SELECT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        e.`parent_entity_id`, null as parent_table,
        e.`entity_type_id`, '${locale}' as locale, '${table}' as table_name
        FROM `${table}` e WHERE e.`status` = 'ACTIVE'
    </sql>

    <sql id="count">
        SELECT COUNT(*) FROM `${table}` e WHERE e.`status` = 'ACTIVE'
    </sql>

    <sql id="orderBy">
        <if test="orderByExpression != null">
            ORDER BY ${orderByExpression}
            <choose>
                <when test="asc">
                    asc
                </when>
                <otherwise>
                    desc
                </otherwise>
            </choose>
        </if>
    </sql>

    <sql id="limit">
        limit ${start},${size}
    </sql>

    <update id="update" parameterType="InsertParameter">
        UPDATE `${table}` SET `end_date` = #{entity.endDate}, `status` = #{entity.status} WHERE `object_id` = #{entity.id} AND `start_date` = #{entity.startDate}
    </update>



</mapper>
