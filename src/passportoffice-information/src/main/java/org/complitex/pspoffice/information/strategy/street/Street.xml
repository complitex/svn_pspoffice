<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.pspoffice.information.strategy.street.Street">

    <select id="find" resultMap="org.complitex.dictionaryfw.entity.DomainObject.DomainObject" parameterType="DomainObjectExample">
        SELECT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        (SELECT ent.`id` FROM `entity` ent WHERE ent.`entity_table` = #{table}) as entity_id,
        (SELECT ent.`entity_table` FROM `entity` ent WHERE ent.`id` = e.`parent_entity_id`) as parent_entity,
        e.`parent_entity_id`, e.`entity_type_id`, '${locale}' as locale, '${table}' as table_name
        FROM `${table}` e WHERE
        <include refid="org.complitex.dictionaryfw.entity.DomainObject.statusFilter"/>
        <include refid="org.complitex.dictionaryfw.entity.DomainObject.filter"/>
        <if test="additionalParams != null and additionalParams['district'] != null">
            AND EXISTS(SELECT 1 FROM `building` b
                        JOIN `building_attribute` ba1 ON (b.`object_id` = ba1.`object_id` AND ba1.`attribute_type_id` = 503 AND ba1.`status` = 'ACTIVE')
                        JOIN `building_attribute` ba2 ON (b.`object_id` = ba2.`object_id` AND ba2.`attribute_type_id` = 504 AND ba2.`status` = 'ACTIVE')
                        WHERE b.`status` = 'ACTIVE' AND ba1.`value_id` = e.`object_id` AND ba2.`value_id` = #{additionalParams.district}
                )
        </if>
        <if test="orderByAttribureTypeId != null">
            ORDER BY (
            SELECT sc.`value` FROM `${table}_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`id` =
            (SELECT orderByAttr.`value_id` FROM `${table}_attribute` orderByAttr WHERE orderByAttr.`object_id` = e.`object_id`
            AND orderByAttr.`status` = 'ACTIVE' AND orderByAttr.`attribute_type_id` = #{orderByAttribureTypeId})
            )
            <choose>
                <when test="asc">
                    ASC
                </when>
                <otherwise>
                    DESC
                </otherwise>
            </choose>
        </if>
        <include refid="org.complitex.dictionaryfw.entity.DomainObject.limit"/>
    </select>

</mapper>