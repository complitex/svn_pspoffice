<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.dictionaryfw.entity.Attribute">

    <resultMap id="Attribute" type="Attribute">
        <id column="attribute_id" property="attributeId"/>
        <id column="object_id" property="objectId"/>
        <id column="attribute_type_id" property="attributeTypeId"/>
        <id column="start_date" property="startDate"/>
        <result column="status" property="status"/>
        <result column="end_date" property="endDate"/>
        <result column="value_id" property="valueId"/>
        <result column="value_type_id" property="valueTypeId"/>
        <collection ofType="StringCulture" property="localizedValues" column="{table = table_name, string = value_id}"
                    select="org.complitex.dictionaryfw.entity.StringCulture.find"/>
    </resultMap>

    <insert id="insert" parameterType="InsertParameter">
        INSERT INTO `${table}_attribute` (`attribute_id`, `object_id`, `attribute_type_id`, `status`, `start_date`, `end_date`, `value_id`, `value_type_id`) VALUES
        (#{entity.attributeId}, #{entity.objectId}, #{entity.attributeTypeId}, #{entity.status}, #{entity.startDate}, #{entity.endDate}, #{entity.valueId}, #{entity.valueTypeId})
    </insert>

    <update id="update" parameterType="InsertParameter">
        UPDATE `${table}_attribute` SET `end_date` = #{entity.endDate}, `status` = #{entity.status} WHERE
        `attribute_id` = #{entity.attributeId} AND `object_id` = #{entity.objectId} AND `attribute_type_id` = #{entity.attributeTypeId} AND `start_date` = #{entity.startDate}
    </update>

    <update id="archiveAttributes" parameterType="hashmap">
        UPDATE `${table}_attribute` SET `end_date` = #{endDate}, `status` = 'ARCHIVE' WHERE
        `attribute_type_id` IN
        <foreach item="id" collection="attributeTypeIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <select id="find" parameterType="hashmap" resultMap="org.complitex.dictionaryfw.entity.Attribute.Attribute">
        SELECT aa.`attribute_id`, aa.`object_id`, aa.`attribute_type_id`, aa.`value_id`, aa.`value_type_id`, aa.`start_date`, aa.`end_date`, aa.`status`,
        '${table}' as table_name
        FROM `${table}_attribute` aa WHERE  aa.`object_id` = #{id} AND aa.`status` = 'ACTIVE'
        ORDER BY aa.`attribute_id`
    </select>

</mapper>
