<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.pspoffice.information.strategy.impl.room.Room">

    <resultMap id="Room_edit" type="Room" extends="org.complitex.dictionaryfw.entity.Entity.Entity_edit">
    </resultMap>

    <resultMap id="Room_view" type="Room" extends="org.complitex.dictionaryfw.entity.Entity.Entity_view">
    </resultMap>
    
    <select id="findById" resultMap="Room_edit" parameterType="RoomExample">
        <include refid="org.complitex.dictionaryfw.entity.Entity.findById"/>        
    </select>

    <sql id="filter">
        <if test="name != null">
            AND EXISTS(SELECT 1 FROM `room_attribute` aa WHERE aa.`attribute_type_id` = 2 AND aa.`object_id` = e.`object_id` AND
            aa.`status` = 'ACTIVE' AND aa.`start_date` >= e.`start_date` AND
            aa.`value_id` IN (SELECT a_sc.id FROM `room_string_culture` a_sc WHERE a_sc.value LIKE '%${name}%'))
        </if>
    </sql>

    <select id="find" resultMap="Room_view" parameterType="RoomExample">
        <include refid="org.complitex.dictionaryfw.entity.Entity.find"/>
        <include refid="org.complitex.pspoffice.information.strategy.impl.room.Room.filter"/>
        ORDER BY (SELECT sc.`value` FROM `room_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`id` =
                   (SELECT aa.`value_id` FROM `room_attribute` aa WHERE aa.`attribute_type_id` = 2 AND aa.`object_id` = e.`object_id`
                   AND aa.`status` = 'ACTIVE' AND aa.`start_date` >= e.`start_date`))
                    <choose>
                        <when test="asc">
                            asc
                        </when>
                        <otherwise>
                            desc
                        </otherwise>
                    </choose>
    </select>

    <select id="count" resultType="int" parameterType="RoomExample">
        <include refid="org.complitex.dictionaryfw.entity.Entity.count"/>
        <include refid="org.complitex.pspoffice.information.strategy.impl.room.Room.filter"/>
    </select>    

</mapper>
